---
title: "AWS EC2ã‚’ä½¿ã£ã¦ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™ã‚’çªç ´ã™ã‚‹CLIãƒ„ãƒ¼ãƒ«ã‚’Rustã§ä½œã£ãŸ"
emoji: "ğŸŒ"
type: "tech"
topics: ["rust", "aws", "cli", "proxy", "opensource"]
published: false
---

# ã¯ã˜ã‚ã«

ã€Œæ—¥æœ¬ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€ã€Œã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãŠä½ã¾ã„ã®åœ°åŸŸã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€

ã“ã‚“ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™ã¯ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚²ãƒ¼ãƒ ã€APIãªã©ã€ã•ã¾ã–ã¾ãªå ´é¢ã§ç§ãŸã¡ã®å‰ã«ç«‹ã¡ã¯ã ã‹ã‚Šã¾ã™ã€‚

ä»Šå›ã€ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã« **region-proxy** ã¨ã„ã†CLIãƒ„ãƒ¼ãƒ«ã‚’Rustã§ä½œã‚Šã¾ã—ãŸã€‚

https://github.com/M-Igashi/region-proxy

## region-proxy ã¨ã¯

region-proxyã¯ã€**AWS EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä»»æ„ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§èµ·å‹•ã—ã€SSHãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§SOCKS5ãƒ—ãƒ­ã‚­ã‚·ã‚’æ§‹ç¯‰ã™ã‚‹**CLIãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

```bash
# æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ—ãƒ­ã‚­ã‚·ã‚’èµ·å‹•
$ region-proxy start --region ap-northeast-1

# ã“ã‚Œã ã‘ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® localhost:1080 ãŒæ±äº¬çµŒç”±ã®SOCKSãƒ—ãƒ­ã‚­ã‚·ã«ãªã‚‹
```

### ç‰¹å¾´

- ğŸŒ **å…¨AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ**: 33ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰é¸æŠå¯èƒ½
- ğŸš€ **ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰**: ç´„30ç§’ã§ãƒ—ãƒ­ã‚­ã‚·ãŒä½¿ãˆã‚‹
- ğŸ’° **æ¿€å®‰**: t4g.nanoä½¿ç”¨ã§ç´„$0.004/æ™‚é–“ï¼ˆæœˆ$3ç¨‹åº¦ï¼‰
- ğŸ§¹ **è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: åœæ­¢æ™‚ã«AWSãƒªã‚½ãƒ¼ã‚¹ã‚’å…¨å‰Šé™¤
- ğŸ **macOSçµ±åˆ**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’è‡ªå‹•è¨­å®š

## ãªãœä½œã£ãŸã®ã‹

### æ—¢å­˜ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®èª²é¡Œ

| æ–¹æ³• | èª²é¡Œ |
|------|------|
| å•†ç”¨VPN | æœˆé¡$5-15ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒé™å®šçš„ |
| æ‰‹å‹•EC2 + SSH | ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒé¢å€’ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å¿˜ã‚ŒãŒã¡ |
| AWS SSM | è¨­å®šãŒè¤‡é›‘ã€IAMãƒãƒªã‚·ãƒ¼ãŒå¤§å¤‰ |

ã€ŒAWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã•ãˆã‚ã‚Œã°ã€ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§å¥½ããªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’ç«‹ã¦ãŸã„ã€

ã“ã®å˜ç´”ãªé¡˜æœ›ã‹ã‚‰ region-proxy ã¯ç”Ÿã¾ã‚Œã¾ã—ãŸã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     SSH Tunnel      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Your Mac  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  EC2 (Tokyo) â”‚ â”€â”€â–º â”‚   Internet   â”‚
â”‚  SOCKS:1080 â”‚    Port Forwarding  â”‚   t4g.nano   â”‚     â”‚  (JP region) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. **EC2èµ·å‹•**: æŒ‡å®šãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆt4g.nanoï¼‰ã‚’èµ·å‹•
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**: ã‚ãªãŸã®IPã‹ã‚‰ã®SSHã®ã¿è¨±å¯
3. **ã‚­ãƒ¼ãƒšã‚¢ç”Ÿæˆ**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®ä¸€æ™‚SSHã‚­ãƒ¼ã‚’ä½œæˆ
4. **SSHãƒˆãƒ³ãƒãƒ«**: `-D`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
5. **ã‚·ã‚¹ãƒ†ãƒ è¨­å®š**: macOSã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’è‡ªå‹•æ›´æ–°

## æŠ€è¡“çš„ãªã“ã ã‚ã‚Š

### Rustã‚’é¸ã‚“ã ç†ç”±

- **ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒª**: ä¾å­˜é–¢ä¿‚ãªã—ã§é…å¸ƒå¯èƒ½
- **ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: ARM/x86ä¸¡å¯¾å¿œã®ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒã‚¤ãƒŠãƒª
- **å‹å®‰å…¨æ€§**: AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®æ‰±ã„ãƒŸã‚¹ã‚’é˜²æ­¢
- **éåŒæœŸå‡¦ç†**: tokioã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªI/O

### AWS SDK for Rust

```rust
use aws_sdk_ec2::{Client, types::Filter};

async fn find_latest_ami(client: &Client, region: &str) -> Result<String> {
    let resp = client
        .describe_images()
        .owners("amazon")
        .filters(
            Filter::builder()
                .name("name")
                .values("al2023-ami-*-kernel-*-arm64")
                .build(),
        )
        .send()
        .await?;
    
    // æœ€æ–°ã®AMIã‚’å–å¾—
    // ...
}
```

AWS SDK for Rustã¯ã¾ã æ¯”è¼ƒçš„æ–°ã—ã„ã§ã™ãŒã€ååˆ†ã«å®Ÿç”¨çš„ã§ã—ãŸã€‚

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

`anyhow` + `thiserror` ã®çµ„ã¿åˆã‚ã›ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®Ÿç¾ï¼š

```rust
#[derive(Debug, thiserror::Error)]
pub enum ProxyError {
    #[error("No AWS credentials found. Run 'aws configure' first.")]
    NoCredentials,
    
    #[error("Region '{0}' is not supported")]
    UnsupportedRegion(String),
    
    #[error("EC2 instance failed to start: {0}")]
    InstanceStartFailed(String),
}
```

### çŠ¶æ…‹ç®¡ç†

å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚­ã‚·æƒ…å ±ã¯ `~/.region-proxy/state.json` ã«ä¿å­˜ï¼š

```json
{
  "instance_id": "i-0abc123def456789",
  "region": "ap-northeast-1",
  "public_ip": "54.168.xxx.xxx",
  "ssh_pid": 12345,
  "started_at": "2024-01-15T10:30:00Z"
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥å¾Œã®å¾©æ—§ã‚„å­¤ç«‹ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå¯èƒ½ã«ã€‚

## ä½¿ã„æ–¹

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# Homebrew
brew tap M-Igashi/tap
brew install region-proxy

# ã¾ãŸã¯ cargo
cargo install --git https://github.com/M-Igashi/region-proxy
```

### åŸºæœ¬æ“ä½œ

```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
region-proxy config set-region ap-northeast-1

# ãƒ—ãƒ­ã‚­ã‚·é–‹å§‹
region-proxy start

# çŠ¶æ…‹ç¢ºèª
region-proxy status

# åœæ­¢ï¼ˆãƒªã‚½ãƒ¼ã‚¹è‡ªå‹•å‰Šé™¤ï¼‰
region-proxy stop
```

### åˆ©ç”¨å¯èƒ½ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§

```bash
$ region-proxy list-regions --detailed

Americas:
  us-east-1      US East (N. Virginia)         t4g.nano
  us-east-2      US East (Ohio)                t4g.nano
  us-west-1      US West (N. California)       t3.nano
  ...

Asia Pacific:
  ap-northeast-1 Asia Pacific (Tokyo)          t4g.nano
  ap-southeast-1 Asia Pacific (Singapore)      t4g.nano
  ...
```

## ã‚³ã‚¹ãƒˆ

### å®Ÿã‚³ã‚¹ãƒˆ

| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ | æ™‚é–“å˜ä¾¡ | 1æ—¥8æ™‚é–“ | æœˆé–“ï¼ˆ24/7ï¼‰ |
|-------------|---------|---------|-------------|
| t4g.nano | $0.0042 | $0.034 | $3.02 |
| t3.nano | $0.0052 | $0.042 | $3.74 |

**ä½¿ã£ãŸåˆ†ã ã‘**ã®èª²é‡‘ãªã®ã§ã€å¿…è¦ãªã¨ãã ã‘èµ·å‹•ã™ã‚Œã°æœˆé¡æ•°åå††ã€œæ•°ç™¾å††ç¨‹åº¦ã§ã™ã€‚

## ä»Šå¾Œã®äºˆå®š

- [ ] Linuxå¯¾å¿œ
- [ ] è¤‡æ•°åŒæ™‚æ¥ç¶š
- [ ] æ¥ç¶šæ™‚é–“åˆ¶é™
- [ ] ã‚³ã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
- [ ] Homebrewå…¬å¼tapç”³è«‹

## ã¾ã¨ã‚

region-proxy ã¯ã€AWSã‚’ä½¿ã£ã¦æ‰‹è»½ã«ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™ã‚’çªç ´ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

- VPNã‚µãƒ¼ãƒ“ã‚¹ã«èª²é‡‘ã—ãŸããªã„
- ç‰¹å®šã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦
- AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æŒã£ã¦ã„ã‚‹

ã“ã‚“ãªæ–¹ã«ã´ã£ãŸã‚Šã§ã™ã€‚ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼

https://github.com/M-Igashi/region-proxy

â­ ã‚¹ã‚¿ãƒ¼ã‚’ã„ãŸã ã‘ã‚‹ã¨åŠ±ã¿ã«ãªã‚Šã¾ã™ï¼

## å‚è€ƒãƒªãƒ³ã‚¯

- [GitHub ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/M-Igashi/region-proxy)
- [AWS SDK for Rust](https://aws.amazon.com/sdk-for-rust/)
- [SSH ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°](https://www.ssh.com/academy/ssh/tunneling-example)
